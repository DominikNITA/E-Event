<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion avec Backend Express</title>
</head>

<body>
    <div class="main">
        <section>
            <h2>1) Connexion avec mdp (path: /auth/login)</h2>
            <p>Pour une paire email/mdp le serveur renvoie un token d'authentification unique qu'il faut ensuite
                transmettre dans l'en-tete des prochaines requetes. Si le mdp ou le mail est incorrect le serveur
                renvoie une erreur.</p>
            <p>Example user => email: rickyboi@gmail.com | mdp: 123456</p>
            <form id="login-form">
                Email: <input type="email" name="email">
                Password: <input type="password" name="password">
                <input type="submit">
            </form>
            <div class="response" id="response-login">
                No response
            </div>
        </section>

        <section>
            <h2>2) Obtenir un evenement specifique par ID (path: /events/{id})</h2>
            <p>Par defaut le lieu, le groupe qui organise l'event et les participants NE SONT PAS inclus dans la
                reponse! </p>
            <p>Exemple de path: /events/1 ou /events/12320</p>
            <form id="eventId-form">
                Event Id: <input type="number" name="eventId">
                <input type="submit">
            </form>
            <div class="response" id="response-eventId">
                No response
            </div>
        </section>

        <section>
            <h2>3) Obtenir un evenement specifique par ID AVEC le lieu (path: /events/{id}?include=place)</h2>
            <p>On utilise "query string" (<a href="https://en.wikipedia.org/wiki/Query_string">WIKI</a>)
                pour demander des informations suplementaires. Pour les evenements il y a un query appele 'include' qui
                prend comme parametres: place, organizer et/ou participants. On peut passer des listes pour obtenir
                plusieurs info avec une requete, exemple: ?include=place,organizer
            </p>
            <form id="eventIdWithPlace-form">
                Event Id: <input type="number" name="eventId">
                <input type="submit">
            </form>
            <div class="response" id="response-eventIdWithPlace">
                No response
            </div>
        </section>

        <section>
            <h2>4) Recherche d'un evenement par mot-cle <br /> (path: /events?search=LaChaineDeCaractereARechercher)
            </h2>
            <p>La on utilise encore une fois une 'query'. Cette fois, elle s'appelle 'search' et prend en parametre une
                chaine de caracteres qu'on veut retrouver dans le titre ou la description des evenements.</p>
            <form id="eventSearch-form">
                Search: <input name="search">
                <input type="submit">
            </form>
            <div class="response" id="response-eventSearch">
                No response
            </div>
        </section>

        <section>
            <h2>5) Obtenir un utilisateur specifique par ID (path: /users/{id})</h2>
            <form id="userId-form">
                User Id: <input type="number" name="userId">
                <input type="submit">
            </form>
            <div class="response" id="response-userId">
                No response
            </div>
        </section>
    </div>
</body>

<script>
    const serverAddress = "http://localhost:3000";

    let authToken = null;

    /* 
      1)  Connexion avec le mot de passe
    */
    const loginForm = document.getElementById("login-form");
    const loginResponse = document.getElementById("response-login");

    let login = function (formEvent) {
        formEvent.preventDefault(); // par defaut la page serait rechargee et on veut le prevenir

        const requestBody = {
            email: formEvent.target.elements.email.value,
            password: formEvent.target.elements.password.value
        };

        fetch(`${serverAddress}/auth/login`, {
            method: "POST",         // le meme type de "methode" que indique sur swagger
            headers: {
                'Content-Type': 'application/json' // vous envoyez un "body" de type JSON donc il faut l'indique au serveur
            },
            body: JSON.stringify(requestBody) //Transformer un objet vers la representation JSON
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); //Transformer un string JSON vers un objet JavaScript
                }
                else {
                    response.text().then(text => loginResponse.textContent = text)
                }
            })
            .then(data => {
                loginResponse.textContent = "AuthToken is: " + data.accessToken + "\n. Token est sauvegarde et sera utilise pour les requetes suivantes.";
                authToken = data.accessToken;
            })
            .catch((error) => loginResponse.textContent = error);
    }

    loginForm.addEventListener('submit', login);


    /*
      2)  Obtenir un evenement specifique par ID
    */
    const eventIdForm = document.getElementById("eventId-form");
    const eventIdResponse = document.getElementById("response-eventId");

    function requestEventById(formEvent) {
        formEvent.preventDefault();
        console.warn("WHAT!");
        console.log(formEvent.target.elements);
        fetch(`${serverAddress}/events/${formEvent.target.elements.eventId.value}`, {
            method: "GET",
            headers: {
                'auth': authToken
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json() //Transformer un string JSON vers un objet JavaScript
                }
                else {
                    response.text().then(text => eventIdResponse.textContent = text)
                }
            })
            .then(data => eventIdResponse.textContent = `Event name: ${data.name}`)
            .catch((error) => eventIdResponse.textContent = error);
    }

    eventIdForm.addEventListener("submit", requestEventById);


    /*
        3)  Obtenir un evenement specifique par ID
    */
    const eventIdWithPlaceForm = document.getElementById("eventIdWithPlace-form");
    const eventIdWithPlaceResponse = document.getElementById("response-eventIdWithPlace");

    function requestEventByIdWithPlace(formEvent) {
        formEvent.preventDefault();
        fetch(`${serverAddress}/events/${formEvent.target.elements.eventId.value}?include=place`, {
            method: "GET",
            headers: {
                'auth': authToken
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json() //Transformer un string JSON vers un objet JavaScript
                }
                else {
                    response.text().then(text => eventIdWithPlaceResponse.textContent = text)
                }
            })
            .then(data => eventIdWithPlaceResponse.textContent = `Event place: ${JSON.stringify(data.place)}`)
            .catch((error) => eventIdWithPlaceResponse.textContent = error);
    }

    eventIdWithPlaceForm.addEventListener("submit", requestEventByIdWithPlace);


    /*
        4)  Recherche d'un evenement par mot-cle (dans le titre ou description)
    */
    const eventSearchForm = document.getElementById("eventSearch-form");
    const eventSearchResponse = document.getElementById("response-eventSearch");

    function searchEvent(formEvent) {
        formEvent.preventDefault();
        fetch(`${serverAddress}/events?search=${formEvent.target.elements.search.value}`, {
            method: "GET",
            headers: {
                'auth': authToken
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json() //Transformer un string JSON vers un objet JavaScript
                }
                else {
                    response.text().then(text => eventSearchResponse.textContent = text)
                }
            })
            .then(data => eventSearchResponse.textContent = `Found events: ${JSON.stringify(data)}`)
            .catch((error) => eventSearchResponse.textContent = error);
    }

    eventSearchForm.addEventListener("submit", searchEvent);

    /*
      5)  Obtenir un utilisateur specifique par ID
    */
    const userIdForm = document.getElementById("userId-form");
    const userIdResponse = document.getElementById("response-userId");

    function requestUserById(formEvent) {
        fetch(`${serverAddress}/users/${formEvent.target.elements.userId.value}`, {
            method: "GET",
            headers: {
                'auth': authToken
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.json() //Transformer un string JSON vers un objet JavaScript
                }
                else {
                    response.text().then(text => userIdResponse.textContent = text)
                }
            })
            .then(data => userIdResponse.textContent = `Utilisateur: ${JSON.stringify(data)}`)
            .catch((error) => userIdResponse.textContent = error);

        formEvent.preventDefault();
    }

    userIdForm.addEventListener("submit", requestUserById);

</script>

<style>
    .main {
        width: 100vw;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        align-items: center;
    }

    .main>* {
        margin-top: 3rem;
    }

    .response {
        width: 100%;
        max-width: 70vw;
        background-color: azure;
        margin-top: 1rem;
        padding: 0.3rem;
        font-weight: 700;
        word-wrap: break-word;
    }

    p {
        max-width: 70vw;
    }
</style>

</html>